<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Interactive Clinical Trials Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:'Inter',sans-serif;background:#111827}
  .chart-container{position:relative;margin:auto;height:300px;width:100%}
  ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:#1f2937}
  ::-webkit-scrollbar-thumb{background:#4b5563;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#6b7280}
  .loader{border:4px solid #f3f3f3;border-top:4px solid #00ACFF;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  input[type='number']::-webkit-inner-spin-button,input[type='number']::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
  input[type='number']{-moz-appearance:textfield}
  input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(.8);cursor:pointer}
  fieldset:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body class="text-gray-200 p-4">
  <!-- Header -->
  <header class="mb-8">
    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-white">Clinical Trial Dashboard</h1>
        <p class="text-sm text-gray-400 mt-1">
          Industry-sponsored interventional trials • Source:
          <a href="https://clinicaltrials.gov" target="_blank" class="text-blue-400 hover:underline">ClinicalTrials.gov</a>
        </p>
      </div>
      <div class="text-sm text-gray-400 mt-2 sm:mt-0">Updated: <span id="lastUpdated"></span></div>
    </div>
  </header>

  <!-- Filters -->
  <div class="bg-gray-800 rounded-lg shadow-lg mb-4">
    <div id="toggleFiltersHeader" class="flex justify-between items-center p-2 cursor-pointer">
      <h2 class="text-sm font-semibold text-white">Filters</h2>
      <svg id="toggleIcon" class="w-6 h-6 text-gray-400 transition-transform duration-300 transform rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
    </div>
    <fieldset id="filters" class="grid grid-cols-1 sm:grid-cols-4 gap-3 p-4 border-t border-gray-700">
      <div class="sm:col-span-2">
        <label class="text-sm text-gray-300 block mb-1" for="keywordSearch">Keyword Search</label>
        <input id="keywordSearch" type="text" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search NCT, Title, Sponsor, Condition...">
      </div>
      <div class="sm:col-span-2">
        <label class="text-sm text-gray-300 block mb-1" for="sponsorFilter">Sponsor</label>
        <input id="sponsorFilter" list="sponsorList" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type or select a sponsor">
        <datalist id="sponsorList"></datalist>
      </div>
      <div>
        <label class="text-sm text-gray-300 block mb-1" for="statusFilter">Status</label>
        <select id="statusFilter" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All Statuses</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-gray-300 block mb-1" for="phaseFilter">Phase</label>
        <select id="phaseFilter" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All Phases</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-gray-300 block mb-1" for="startDateFilter">Start Date From</label>
        <input id="startDateFilter" type="date" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="flex items-end gap-2">
        <button id="resetFilters" class="flex-1 bg-blue-600 hover:bg-blue-700 rounded-md py-2 px-3 text-white font-semibold">Reset</button>
      </div>
    </fieldset>
  </div>

  <!-- KPIs -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm">Total Trials</h3><p id="totalTrials" class="text-3xl font-bold text-white">0</p></div>
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm">Recruiting</h3><p id="recruitingTrials" class="text-3xl font-bold text-green-400">0</p></div>
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm">Completed</h3><p id="completedTrials" class="text-3xl font-bold text-blue-400">0</p></div>
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg"><h3 class="text-gray-400 text-sm">Total Participants</h3><p id="totalParticipants" class="text-3xl font-bold text-white">0</p></div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-1">
      <h3 class="font-semibold text-white mb-4 text-center">Trials by Phase</h3>
      <div class="chart-container"><canvas id="phaseChart"></canvas></div>
    </div>
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-2">
      <h3 class="font-semibold text-white mb-4 text-center">Trials by Status</h3>
      <div class="chart-container"><canvas id="statusChart"></canvas></div>
    </div>
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-3">
      <h3 class="font-semibold text-white mb-4 text-center">Trials Started Over Time</h3>
      <div class="chart-container !h-[350px]"><canvas id="timeChart"></canvas></div>
    </div>
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-2">
      <h3 class="font-semibold text-white mb-4 text-center">Top 10 Sponsors</h3>
      <div class="chart-container !h-[400px]"><canvas id="sponsorChart"></canvas></div>
    </div>
    <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-1">
      <h3 class="font-semibold text-white mb-4 text-center">Top Conditions</h3>
      <div class="chart-container !h-[400px]"><canvas id="conditionsChart"></canvas></div>
    </div>
  </div>

  <!-- Data Table -->
  <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
    <div class="p-4 flex flex-wrap gap-2 justify-between items-center">
      <h3 class="font-semibold text-white">Trial Details</h3>
      <div class="flex items-center gap-2 text-sm">
        <span id="tableRecordCount" class="text-gray-400"></span>
        <label class="text-gray-400">Rows/page
          <select id="pageSize" class="ml-1 bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-gray-100">
            <option>50</option><option selected>100</option><option>150</option><option>200</option>
          </select>
        </label>
        <div class="flex items-center gap-1">
          <button id="prevPage" class="bg-gray-700 hover:bg-gray-600 rounded px-2 py-1">Prev</button>
          <span id="pageInfo" class="text-gray-300 mx-1"></span>
          <button id="nextPage" class="bg-gray-700 hover:bg-gray-600 rounded px-2 py-1">Next</button>
        </div>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-xs text-left text-gray-300">
        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
          <tr>
            <th class="px-4 py-3" style="min-width:120px">NCT Number</th>
            <th class="px-4 py-3" style="min-width:300px">Title</th>
            <th class="px-4 py-3 text-center" style="min-width:150px">Status</th>
            <th class="px-4 py-3" style="min-width:100px">Phase</th>
            <th class="px-4 py-3" style="min-width:200px">Sponsor</th>
            <th class="px-4 py-3" style="min-width:110px">Start Date</th>
            <th class="px-4 py-3 text-right" style="min-width:100px">Enrollment</th>
          </tr>
        </thead>
        <tbody id="trialsTableBody"></tbody>
      </table>
    </div>
  </div>

<script>
/* ---------- GLOBALS ---------- */
let allTrials = [];            // preprocessed
let filtered = [];             // current filtered set
let currentPage = 1;
let phaseChart, statusChart, sponsorChart, timeChart, conditionsChart;

const palette = { dodgerBlue:'#00ACFF', robinsEgg:'#00DAC8', deepSapphire:'#001E63', sulu:'#CAFF5E', malibu:'#6EC3FA' };

/* ---------- UTIL ---------- */
const debounce = (fn, d=250)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),d);}};

function setLoading(isLoading, msg='') {
  const tableBody = document.getElementById('trialsTableBody');
  const filters = document.getElementById('filters');
  filters.disabled = isLoading;
  if (isLoading) {
    tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-16">
      <div class="flex flex-col items-center"><div class="loader"></div>
      <p class="mt-4 text-lg">${msg}</p></div></td></tr>`;
  } else {
    tableBody.innerHTML = '';
  }
}

function safeDateMs(s) {
  if (!s || s === 'N/A') return NaN;
  const d = new Date(s);
  return isNaN(d.getTime()) ? NaN : d.getTime();
}

/* ---------- CACHING ---------- */
const CACHE_KEY = 'ctgov_industry_trials_v2_cache';
const CACHE_TTL_MS = 24*60*60*1000; // 24h

function readCache() {
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !obj.time || !obj.data) return null;
    if (Date.now() - obj.time > CACHE_TTL_MS) return null;
    return obj.data;
  } catch { return null; }
}

function writeCache(data) {
  try { localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), data })); } catch {}
}

/* ---------- WORKER (FETCH + MAP) ---------- */
const workerScript = `
  async function fetchAll() {
    const BASE = 'https://clinicaltrials.gov/api/v2/studies';
    const Q = 'query.term=AREA[StartDate]RANGE[2020-01-01,MAX]+AND+AREA[OrgClass]INDUSTRY+AND+AREA[StudyType]INTERVENTIONAL';
    let token=null, page=1, out=[];
    try{
      do{
        postMessage({type:'progress',page});
        let url = BASE + '?pageSize=500&' + Q + (token?('&pageToken='+token):'');
        const r = await fetch(url);
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        const arr = (j.studies||[]).map(s=>{
          const p = s.protocolSection||{};
          const id = p.identificationModule||{};
          const st = p.statusModule||{};
          const des = p.designModule||{};
          const sc = p.sponsorCollaboratorsModule||{};
          const cm = p.conditionsModule||{};
          const nct = id.nctId || 'N/A';
          const title = id.officialTitle || 'No title provided';
          const status = st.overallStatus || 'UNKNOWN';
          const phase = (des.phases && des.phases.length ? des.phases[des.phases.length-1] : 'Not Applicable');
          const sponsor = (sc.leadSponsor && sc.leadSponsor.name) ? sc.leadSponsor.name : 'N/A';
          const startDate = (st.startDateStruct && st.startDateStruct.date) ? st.startDateStruct.date : 'N/A';
          const enrollment = (des.enrollmentInfo && des.enrollmentInfo.count) ? des.enrollmentInfo.count : 0;
          const conditions = Array.isArray(cm.conditions)? cm.conditions : [];
          return { nct, title, status, phase, sponsor, startDate, enrollment, conditions };
        });
        out.push(...arr);
        token = j.nextPageToken || null;
        page++;
      } while(token && page<60);
      postMessage({type:'complete',data:out});
    }catch(e){
      postMessage({type:'error',error:String(e)});
    }
  }
  fetchAll();
`;

function startWorker() {
  const blob = new Blob([workerScript], {type:'application/javascript'});
  const w = new Worker(URL.createObjectURL(blob));
  w.onmessage = (e)=>{
    const {type, data, page, error} = e.data;
    if (type==='progress') setLoading(true, 'Fetching page '+page+'…');
    if (type==='complete') {
      setLoading(false);
      writeCache(data);
      preprocess(data);
      initAfterData();
      w.terminate();
    }
    if (type==='error') {
      setLoading(false);
      console.error(error);
      const tbody = document.getElementById('trialsTableBody');
      tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-red-400">Failed to load: ${error}</td></tr>`;
      w.terminate();
    }
  };
  w.onerror = (err)=>{
    setLoading(false);
    console.error(err);
    w.terminate();
  };
}

/* ---------- PREPROCESS ---------- */
function preprocess(raw) {
  // add precomputed lowercase fields and numeric timestamp
  allTrials = raw.map(t=>{
    const startTs = safeDateMs(t.startDate);
    return {
      ...t,
      _title: (t.title||'').toLowerCase(),
      _sponsor: (t.sponsor||'').toLowerCase(),
      _nct: (t.nct||'').toLowerCase(),
      _conditions: Array.isArray(t.conditions)? t.conditions.map(c=>c.toLowerCase()) : [],
      _status: (t.status||'').toUpperCase(),
      startTs
    };
  });
}

/* ---------- FILTERS + PAGINATION ---------- */
function readFilters() {
  return {
    keyword: document.getElementById('keywordSearch').value.trim().toLowerCase(),
    sponsor: document.getElementById('sponsorFilter').value.trim().toLowerCase(),
    status: document.getElementById('statusFilter').value,
    phase: document.getElementById('phaseFilter').value,
    startFrom: document.getElementById('startDateFilter').value
  };
}

function applyFilters() {
  if (!allTrials.length) return [];
  const {keyword,sponsor,status,phase,startFrom} = readFilters();
  const startMs = startFrom ? safeDateMs(startFrom) : NaN;

  const out = allTrials.filter(t=>{
    // keyword across nct/title/sponsor/conditions
    const kw = !keyword || t._nct.includes(keyword) || t._title.includes(keyword) || t._sponsor.includes(keyword) || t._conditions.some(c=>c.includes(keyword));
    if (!kw) return false;
    if (status && t.status !== status) return false;
    if (phase && t.phase !== phase) return false;
    if (sponsor && !t._sponsor.includes(sponsor)) return false;
    if (!isNaN(startMs) && !(t.startTs>=startMs)) return false;
    return true;
  });

  // newest first
  out.sort((a,b)=>( (b.startTs||0) - (a.startTs||0) ));
  return out;
}

function setPage(n) {
  currentPage = Math.max(1, Math.min(n, totalPages()));
}

function pageSize() {
  return parseInt(document.getElementById('pageSize').value, 10) || 100;
}

function totalPages() {
  return Math.max(1, Math.ceil(filtered.length / pageSize()));
}

/* ---------- CHARTS ---------- */
function initCharts() {
  Chart.register(ChartDataLabels);
  const common = {
    responsive:true, maintainAspectRatio:false, animation:false,
    plugins:{ legend:{labels:{color:'#d1d5db'}}, tooltip:{enabled:true} },
    scales:{
      x:{ticks:{color:'#d1d5db'}, grid:{color:'rgba(255,255,255,.08)'}},
      y:{ticks:{color:'#d1d5db'}, grid:{color:'rgba(255,255,255,.08)'}}
    }
  };

  phaseChart = new Chart(document.getElementById('phaseChart'), {
    type:'doughnut',
    data:{labels:[],datasets:[{data:[],backgroundColor:[palette.dodgerBlue,palette.robinsEgg,palette.sulu,palette.malibu,palette.deepSapphire],borderColor:'#1f2937',borderWidth:3}]},
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{
        legend:{display:false},
        datalabels:{
          display:(ctx)=> (ctx.chart.data.labels.length<=8),
          formatter:(v,ctx)=>{
            const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1;
            const pct = (v/total)*100;
            let label = ctx.chart.data.labels[ctx.dataIndex]||'';
            if (label.includes('Applicable')) label='N/A';
            if (label.startsWith('Phase ')) label=label.replace('Phase ','P');
            return pct<3?'':`${label}\n${pct.toFixed(0)}%`;
          },
          color:'#001E63', font:{weight:'bold',size:12,family:'Inter'}
        }
      }
    }
  });

  statusChart = new Chart(document.getElementById('statusChart'), {
    type:'bar',
    data:{labels:[],datasets:[{label:'Number of Trials', data:[], backgroundColor:palette.dodgerBlue}]},
    options:common
  });

  timeChart = new Chart(document.getElementById('timeChart'), {
    type:'line',
    data:{labels:[],datasets:[{label:'Trials Started', data:[], borderColor:palette.robinsEgg, backgroundColor:'rgba(0,218,200,.35)', tension:0.15, fill:false, pointRadius:2}]},
    options:common
  });

  sponsorChart = new Chart(document.getElementById('sponsorChart'), {
    type:'bar',
    data:{labels:[],datasets:[{data:[], backgroundColor:palette.malibu}]},
    options:{
      ...common, indexAxis:'y',
      plugins:{ ...common.plugins, legend:{display:false}, datalabels:{display:true,color:palette.deepSapphire,anchor:'end',align:'end',font:{weight:'bold'}}}
    }
  });

  conditionsChart = new Chart(document.getElementById('conditionsChart'), {
    type:'bar',
    data:{labels:[],datasets:[{data:[], backgroundColor:palette.sulu}]},
    options:{
      ...common, indexAxis:'y',
      plugins:{ ...common.plugins, legend:{display:false}, datalabels:{display:true,color:palette.deepSapphire,anchor:'end',align:'end',font:{weight:'bold'}}}
    }
  });
}

function updateCharts(trials){
  if(!phaseChart) return;

  // Phase
  const phaseCounts = trials.reduce((a,t)=>{a[t.phase]=(a[t.phase]||0)+1; return a;}, {});
  const phases = Object.entries(phaseCounts).sort(([,A],[,B])=>B-A);
  phaseChart.data.labels = phases.map(([k])=>k);
  phaseChart.data.datasets[0].data = phases.map(([,v])=>v);
  phaseChart.update('none');

  // Status
  const statusCounts = trials.reduce((a,t)=>{a[t.status]=(a[t.status]||0)+1; return a;}, {});
  const statuses = Object.entries(statusCounts).sort(([,A],[,B])=>B-A);
  statusChart.data.labels = statuses.map(([k])=>k.replace(/_/g,' '));
  statusChart.data.datasets[0].data = statuses.map(([,v])=>v);
  statusChart.update('none');

  // Time by year
  const timeCounts = trials.reduce((a,t)=>{
    if (!isNaN(t.startTs)) {
      const y = new Date(t.startTs).getFullYear();
      a[y]=(a[y]||0)+1;
    }
    return a;
  },{});
  const years = Object.keys(timeCounts).map(Number).sort((a,b)=>a-b);
  timeChart.data.labels = years;
  timeChart.data.datasets[0].data = years.map(y=>timeCounts[y]);
  // Avoid heavy markers when many points
  timeChart.data.datasets[0].pointRadius = years.length>30?0:2;
  timeChart.update('none');

  // Sponsors (top 10)
  const sponsorCounts = trials.reduce((a,t)=>{ if(t.sponsor && t.sponsor!=='N/A') a[t.sponsor]=(a[t.sponsor]||0)+1; return a; },{});
  const topSponsors = Object.entries(sponsorCounts).sort(([,A],[,B])=>B-A).slice(0,10).reverse();
  sponsorChart.data.labels = topSponsors.map(([k])=>k);
  sponsorChart.data.datasets[0].data = topSponsors.map(([,v])=>v);
  sponsorChart.update('none');

  // Conditions (top 10, skip “healthy”)
  const condCounts = trials.reduce((a,t)=>{
    (t.conditions||[]).forEach(c=>{
      const lc = (c||'').toLowerCase();
      if (!lc.includes('healthy')) a[c]=(a[c]||0)+1;
    });
    return a;
  },{});
  const topConds = Object.entries(condCounts).sort(([,A],[,B])=>B-A).slice(0,10).reverse();
  conditionsChart.data.labels = topConds.map(([k])=>k);
  conditionsChart.data.datasets[0].data = topConds.map(([,v])=>v);
  conditionsChart.update('none');
}

/* ---------- KPIs ---------- */
function updateKPIs(trials){
  document.getElementById('totalTrials').textContent = trials.length.toLocaleString();
  document.getElementById('recruitingTrials').textContent = trials.filter(t=>t._status==='RECRUITING').length.toLocaleString();
  document.getElementById('completedTrials').textContent = trials.filter(t=>t._status==='COMPLETED').length.toLocaleString();
  const totalParticipants = trials.reduce((s,t)=> s + (t.enrollment||0), 0);
  document.getElementById('totalParticipants').textContent = totalParticipants.toLocaleString();
}

/* ---------- TABLE (PAGINATED) ---------- */
function getPageSlice() {
  const size = pageSize();
  const start = (currentPage-1)*size;
  return filtered.slice(start, start+size);
}

function statusBadgeStyle(status){
  switch(status){
    case 'RECRUITING': return `background-color:${palette.sulu}; color:${palette.deepSapphire};`;
    case 'COMPLETED': return `background-color:${palette.malibu}; color:${palette.deepSapphire};`;
    case 'TERMINATED': return `background-color:#F87171; color:#7f1d1d;`;
    case 'NOT_YET_RECRUITING': return `background-color:#FBBF24; color:#78350f;`;
    default: return `background-color:#4B5563; color:#F9FAFB;`;
  }
}

function renderTable(){
  const tbody = document.getElementById('trialsTableBody');
  const countEl = document.getElementById('tableRecordCount');
  const pageEl = document.getElementById('pageInfo');

  if (!filtered.length){
    tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-400">No trials match the current filters.</td></tr>`;
    countEl.textContent = 'Showing 0 records';
    pageEl.textContent = '0 / 0';
    return;
  }

  const rows = getPageSlice().map(t=>`
    <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700/50">
      <td class="px-4 py-3 font-medium text-blue-400 whitespace-nowrap">
        <a href="https://clinicaltrials.gov/study/${t.nct}" target="_blank" class="hover:underline">${t.nct}</a>
      </td>
      <td class="px-4 py-3 whitespace-normal break-words">${t.title}</td>
      <td class="px-4 py-3 text-center whitespace-nowrap">
        <span class="px-2 py-1 rounded-full text-xs font-semibold" style="${statusBadgeStyle(t.status)}">${t.status.replace(/_/g,' ')}</span>
      </td>
      <td class="px-4 py-3">${t.phase}</td>
      <td class="px-4 py-3 whitespace-normal break-words">${t.sponsor}</td>
      <td class="px-4 py-3 whitespace-nowrap">${t.startDate||''}</td>
      <td class="px-4 py-3 text-right">${(t.enrollment||0).toLocaleString()}</td>
    </tr>`).join('');
  tbody.innerHTML = rows;

  const size = pageSize();
  const shown = Math.min(filtered.length - (currentPage-1)*size, size);
  countEl.textContent = `Showing ${shown} of ${filtered.length.toLocaleString()} records`;
  pageEl.textContent = `${currentPage} / ${totalPages()}`;
}

/* ---------- FILTER POPULATION ---------- */
function populateFilters(){
  const statusFilter = document.getElementById('statusFilter');
  const phaseFilter = document.getElementById('phaseFilter');
  const sponsorList = document.getElementById('sponsorList');

  statusFilter.length = 1;
  phaseFilter.length = 1;
  sponsorList.innerHTML = '';

  const statuses = [...new Set(allTrials.map(t=>t.status))].sort();
  const phases = [...new Set(allTrials.map(t=>t.phase))].sort((a,b)=>{
    if (a.includes('Not Applicable')) return -1;
    if (b.includes('Not Applicable')) return 1;
    return a.localeCompare(b);
  });

  const sponsorCounts = allTrials.reduce((a,t)=>{ if (t.sponsor && t.sponsor!=='N/A') a[t.sponsor]=(a[t.sponsor]||0)+1; return a; },{});
  const sponsorsTop = Object.entries(sponsorCounts).sort(([,A],[,B])=>B-A).slice(0,500).map(([s])=>s);

  statuses.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s.replace(/_/g,' '); statusFilter.appendChild(o); });
  phases.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; phaseFilter.appendChild(o); });
  sponsorsTop.forEach(s=>{ const o=document.createElement('option'); o.value=s; sponsorList.appendChild(o); });
}

/* ---------- UPDATE PIPELINE ---------- */
function updateAll(){
  filtered = applyFilters();
  updateKPIs(filtered);
  updateCharts(filtered);
  setPage(1);
  renderTable();
}

const debouncedUpdateAll = debounce(()=>{ filtered = applyFilters(); updateKPIs(filtered); updateCharts(filtered); setPage(1); renderTable(); }, 250);

/* ---------- INIT ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  initCharts();

  // UI listeners
  const filtersEl = document.getElementById('filters');
  const icon = document.getElementById('toggleIcon');
  document.getElementById('toggleFiltersHeader').addEventListener('click', ()=>{
    const isHidden = filtersEl.classList.toggle('hidden');
    icon.classList.toggle('rotate-180', !isHidden);
  });

  // Debounced text inputs
  document.getElementById('keywordSearch').addEventListener('input', debouncedUpdateAll);
  document.getElementById('sponsorFilter').addEventListener('input', debouncedUpdateAll);
  // Change events
  ['statusFilter','phaseFilter','startDateFilter'].forEach(id=>{
    document.getElementById(id).addEventListener('change', debouncedUpdateAll);
  });

  document.getElementById('resetFilters').addEventListener('click', ()=>{
    ['keywordSearch','sponsorFilter','statusFilter','phaseFilter','startDateFilter'].forEach(id=>document.getElementById(id).value='');
    debouncedUpdateAll();
  });

  document.getElementById('pageSize').addEventListener('change', ()=>{
    setPage(1); renderTable();
  });
  document.getElementById('prevPage').addEventListener('click', ()=>{ setPage(currentPage-1); renderTable(); });
  document.getElementById('nextPage').addEventListener('click', ()=>{ setPage(currentPage+1); renderTable(); });

  // Load: cache first, then network if stale/missing
  const cached = readCache();
  if (cached && Array.isArray(cached) && cached.length){
    preprocess(cached);
    populateFilters();
    setLoading(false);
    updateAll();
    // also refresh in background for next visit
    setTimeout(()=>startWorker(), 0);
  } else {
    setLoading(true,'Loading trials…');
    startWorker();
  }
});

function initAfterData(){
  populateFilters();
  updateAll();
}
</script>
</body>
</html>
