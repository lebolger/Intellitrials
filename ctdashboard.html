<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Clinical Trials Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 300px;
            width: 100%;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00ACFF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide the up/down arrows on number inputs */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
        }
        /* Style for date picker icon */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }
        /* Ensure filters are disabled visually */
        fieldset:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="text-gray-200 p-4 sm:p-4 lg:p-4">

    <header class="mb-8">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-white">Clinical Trial Dashboard</h1>
                <p class="text-sm sm:text-md text-gray-400 mt-1">An interactive dashboard for analyzing industry-sponsored clinical trials. Source: <a href="https://clinicaltrials.gov" target="_blank" class="text-blue-400 hover:underline">ClinicalTrials.gov</a></p>
            </div>
            <div class="text-sm text-gray-400 mt-2 sm:mt-0">Updated: <span id="lastUpdated"></span></div>
        </div>
    </header>

    <div class="bg-gray-800 rounded-lg shadow-lg mb-4">
        <div id="toggleFiltersHeader" class="flex justify-between items-center p-2 cursor-pointer">
            <h2 class="text-sm font-semibold text-white">Filters</h2>
            <svg id="toggleIcon" class="w-6 h-6 text-gray-400 transition-transform duration-300 transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
        <fieldset id="filters" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 p-4 border-t border-gray-700">
            <div class="lg:col-span-2">
                <label for="keywordSearch" class="text-sm font-medium text-gray-300 block mb-1">Keyword Search</label>
                <input type="text" id="keywordSearch" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search Title, Sponsor, Condition...">
            </div>
            <div class="lg:col-span-2">
                <label for="sponsorFilter" class="text-sm font-normal text-gray-300 block mb-1">Sponsor</label>
                <input type="text" id="sponsorFilter" list="sponsorList" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type to search for a sponsor">
                <datalist id="sponsorList"></datalist>
            </div>
            <div>
                <label for="statusFilter" class="text-sm font-medium text-gray-300 block mb-1">Status</label>
                <select id="statusFilter" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                     <option value="">All Statuses</option>
                     <option value="RECRUITING">Recruiting</option>
                     <option value="NOT_YET_RECRUITING">Not Yet Recruiting</option>
                     <option value="ACTIVE_NOT_RECRUITING">Active, Not Recruiting</option>
                     <option value="COMPLETED">Completed</option>
                     <option value="TERMINATED">Terminated</option>
                     <option value="ENROLLING_BY_INVITATION">Enrolling By Invitation</option>
                     <option value="WITHDRAWN">Withdrawn</option>
                </select>
            </div>
            <div>
                <label for="phaseFilter" class="text-sm font-medium text-gray-300 block mb-1">Phase</label>
                <select id="phaseFilter" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Phases</option>
                    <option value="EARLY_PHASE_1">Early Phase 1</option>
                    <option value="PHASE_1">Phase 1</option>
                    <option value="PHASE_2">Phase 2</option>
                    <option value="PHASE_3">Phase 3</option>
                    <option value="PHASE_4">Phase 4</option>
                    <option value="NOT_APPLICABLE">Not Applicable</option>
                </select>
            </div>
            <div>
                <label for="startDateFilter" class="text-sm font-medium text-gray-300 block mb-1">Start Date From</label>
                <input type="date" id="startDateFilter" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-end">
                <button id="resetFilters" class="w-full bg-blue-600 hover:bg-blue-700 rounded-md py-2 px-3 text-white font-semibold transition-colors">Reset</button>
            </div>
        </fieldset>
    </div>


    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-gray-400 text-sm font-medium">Total Trials</h3>
            <p id="totalTrials" class="text-3xl font-bold text-white">0</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-gray-400 text-sm font-medium">Recruiting</h3>
            <p id="recruitingTrials" class="text-3xl font-bold text-green-400">0</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-gray-400 text-sm font-medium">Completed</h3>
            <p id="completedTrials" class="text-3xl font-bold text-blue-400">0</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-gray-400 text-sm font-medium">Total Participants</h3>
            <p id="totalParticipants" class="text-3xl font-bold text-white">0</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-1">
            <h3 class="font-semibold text-white mb-4 text-center">Trials by Phase</h3>
            <div class="chart-container"><canvas id="phaseChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-2">
            <h3 class="font-semibold text-white mb-4 text-center">Trials by Status</h3>
            <div class="chart-container"><canvas id="statusChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-3">
            <h3 class="font-semibold text-white mb-4 text-center">Trials Started Over Time</h3>
            <div class="chart-container !h-[350px]"><canvas id="timeChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-2">
            <h3 class="font-semibold text-white mb-4 text-center">Top 10 Sponsors</h3>
            <div class="chart-container !h-[400px]"><canvas id="sponsorChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg xl:col-span-1">
            <h3 class="font-semibold text-white mb-4 text-center">Top Conditions</h3>
            <div class="chart-container !h-[400px]"><canvas id="conditionsChart"></canvas></div>
        </div>
    </div>

    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <div class="p-4 flex justify-between items-center">
            <h3 class="font-semibold text-white">Trial Details</h3>
            <span id="tableRecordCount" class="text-sm text-gray-400"></span>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-xs text-left text-gray-300">
                <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                    <tr>
                        <th scope="col" class="px-4 py-3" style="min-width: 120px;">NCT Number</th>
                        <th scope="col" class="px-4 py-3" style="min-width: 300px;">Title</th>
                        <th scope="col" class="px-4 py-3 text-center" style="min-width: 150px;">Status</th>
                        <th scope="col" class="px-4 py-3" style="min-width: 100px;">Phase</th>
                        <th scope="col" class="px-4 py-3" style="min-width: 200px;">Sponsor</th>
                        <th scope="col" class="px-4 py-3" style="min-width: 100px;">Start Date</th>
                        <th scope="col" class="px-4 py-3 text-right" style="min-width: 100px;">Enrollment</th>
                    </tr>
                </thead>
                <tbody id="trialsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let currentTrials = []; // Holds the currently displayed set of trials
        let dataWorker; // To hold our web worker
        
        const newPalette = {
            dodgerBlue: '#00ACFF',
            robinsEggBlue: '#00DAC8',
            deepSapphire: '#001E63',
            sulu: '#CAFF5E',
            malibu: '#6EC3FA'
        };

        // --- UTILITY FUNCTIONS ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function setLoadingState(isLoading, message = '') {
            const tableBody = document.getElementById('trialsTableBody');
            const filters = document.getElementById('filters');
            
            filters.disabled = isLoading;

            if (isLoading) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-16"><div class="flex flex-col items-center justify-center"><div class="loader"></div><p class="mt-4 text-lg">${message}</p></div></td></tr>`;
            } else {
                // We don't clear the table here anymore, updateDashboard will handle it
            }
        }
        
        // --- WEB WORKER SCRIPT ---
        // OPTIMIZED: The worker now receives filters and builds a specific API query.
        const dataWorkerScript = `
            // Helper function to build the API query string from filter object
            function buildApiQuery(filters) {
                const parts = ['AREA[OrgClass]INDUSTRY', 'AREA[StudyType]INTERVENTIONAL'];
                
                if (filters.keyword) {
                    // Use a general search term. The API is quite flexible with this.
                    parts.push(filters.keyword);
                }
                if (filters.status) {
                    parts.push('AREA[OverallStatus]' + filters.status);
                }
                if (filters.phase) {
                    parts.push('AREA[Phase]' + filters.phase);
                }
                if (filters.sponsor) {
                    parts.push('AREA[LeadSponsorName]' + filters.sponsor);
                }
                if (filters.startDate) {
                    parts.push('AREA[StartDate]RANGE[' + filters.startDate + ',MAX]');
                }

                return parts.join('+AND+');
            }

            async function fetchTrials(filters) {
                const BASE_URL = 'https://clinicaltrials.gov/api/v2/studies';
                const query = buildApiQuery(filters);
                
                // For the initial load without filters, we get the most recent trials instead of all trials.
                const finalQuery = query ? 'query.term=' + query : 'sort=StartDate:desc';

                let allStudies = [];
                let nextPageToken = null;
                let page = 1;
                // Limit to 1000 results for performance. This is now per-query, not total.
                const maxPages = 1; 

                try {
                    do {
                        let paginatedUrl = BASE_URL + '?pageSize=1000&' + finalQuery;
                        if (nextPageToken) {
                            paginatedUrl += '&pageToken=' + nextPageToken;
                        }
                        
                        postMessage({ type: 'progress', page: page });

                        const response = await fetch(paginatedUrl);
                        if (!response.ok) {
                            throw new Error('HTTP error! status: ' + response.status);
                        }
                        const data = await response.json();
                        
                        allStudies.push(...data.studies);
                        nextPageToken = data.nextPageToken;
                        page++;

                    } while (nextPageToken && page <= maxPages);
