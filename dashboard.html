<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Clinical Trials Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 300px;
            width: 100%;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00ACFF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide the up/down arrows on number inputs */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            appearance: textfield;
            -moz-appearance: textfield;
        }
        /* Style for date picker icon */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }
        /* Ensure filters are disabled visually */
        fieldset:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="text-gray-200 p-4 sm:p-4 lg:p-4">

    <!-- Header -->
    <header class="mb-8">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-white">Clinical Trial Dashboard</h1>
                <p class="text-sm sm:text-md text-gray-400 mt-1">An interactive dashboard for analyzing industry-sponsored clinical trials. Source: <a href="https://clinicaltrials.gov" target="_blank" class="text-blue-400 hover:underline">ClinicalTrials.gov</a></p>
            </div>
            <div class="text-sm text-gray-400 mt-2 sm:mt-0">Updated: <span id="lastUpdated"></span></div>
        </div>
    </header>

    <!-- Filters -->
    <div class="bg-gray-800 rounded-lg shadow-lg mb-4">
        <div id="toggleFiltersHeader" class="flex justify-between items-center p-2 cursor-pointer">
            <h2 class="text-sm font-semibold text-white">Filters</h2>
            <svg id="toggleIcon" class="w-6 h-6 text-gray-400 transition-transform duration-300 transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
        <fieldset id="filters" class="grid grid-cols-1 sm:grid-cols-4 lg:grid-cols-4 gap-3 p-4 border-t border-gray-700">
            <!-- Keyword Search -->
            <div class="lg:col-span-2">
                <label for="keywordSearch" class="text-sm font-medium text-gray-300 block mb-1">Keyword Search</label>
                <input type="text" id="keywordSearch" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search NCT, Title, Sponsor, Condition...">
            </div>
            <!-- Sponsor Filter -->
            <div class="lg:col-span-2">
                <label for="sponsorFilter" class="text-sm font-normal text-gray-300 block mb-1">Sponsor</label>
                <input type="text" id="sponsorFilter" list="sponsorList" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type or select a sponsor">
                <datalist id="sponsorList"></datalist>
            </div>
            <!-- Status Filter -->
            <div>
                <label for="statusFilter" class="text-sm font-medium text-gray-300 block mb-1">Status</label>
                <select id="statusFilter" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Statuses</option>
                </select>
            </div>
            <!-- Phase Filter -->
            <div>
                <label for="phaseFilter" class="text-sm font-medium text-gray-300 block mb-1">Phase</label>
                <select id="phaseFilter" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Phases</option>
                </select>
            </div>
            <!-- Start Date Filter -->
            <div>
                <label for="startDateFilter" class="text-sm font-medium text-gray-300 block mb-1">Start Date From</label>
                <input type="date" id="startDateFilter" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <!-- Reset Button -->
            <div class="flex items-end">
                <button id="resetFilters" class="w-full bg-blue-600 hover:bg-blue-700 rounded-md py-2 px-3 text-white font-semibold transition-colors">Reset</button>
            </div>
        </fieldset>
    </div>


    <!-- KPIs -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-gray-400 text-sm font-medium">Total Trials</h3>
            <p id="totalTrials" class="text-3xl font-bold text-white">0</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-gray-400 text-sm font-medium">Recruiting</h3>
            <p id="recruitingTrials" class="text-3xl font-bold text-green-400">0</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-gray-400 text-sm font-medium">Completed</h3>
            <p id="completedTrials" class="text-3xl font-bold text-blue-400">0</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-gray-400 text-sm font-medium">Total Participants</h3>
            <p id="totalParticipants" class="text-3xl font-bold text-white">0</p>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="font-semibold text-white mb-4 text-center">Trials by Phase</h3>
            <div class="chart-container !h-[350px]"><canvas id="phaseChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="font-semibold text-white mb-4 text-center">Trials by Status</h3>
            <div class="chart-container !h-[350px]"><canvas id="statusChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="font-semibold text-white mb-4 text-center">Trials Started Over Time</h3>
            <div class="chart-container !h-[350px]"><canvas id="timeChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg lg:col-span-2">
            <h3 class="font-semibold text-white mb-4 text-center">Top 10 Sponsors</h3>
            <div class="chart-container !h-[400px]"><canvas id="sponsorChart"></canvas></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="font-semibold text-white mb-4 text-center">Top Conditions</h3>
            <div class="chart-container !h-[400px]"><canvas id="conditionsChart"></canvas></div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <div class="p-4 flex justify-between items-center">
            <h3 class="font-semibold text-white">Trial Details</h3>
            <span id="tableRecordCount" class="text-sm text-gray-400"></span>
        </div>
        <!-- This div makes the table scrollable on small screens -->
        <div class="overflow-x-auto">
            <table class="w-full text-xs text-left text-gray-300">
                <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                    <tr>
                        <!-- Using min-width instead of fixed width for better responsiveness -->
                        <th scope="col" class="px-4 py-3" style="min-width: 120px;">NCT Number</th>
                        <th scope="col" class="px-4 py-3" style="min-width: 300px;">Title</th>
                        <th scope="col" class="px-4 py-3 text-center" style="min-width: 150px;">Status</th>
                        <th scope="col" class="px-4 py-3" style="min-width: 100px;">Phase</th>
                        <th scope="col" class="px-4 py-3" style="min-width: 200px;">Sponsor</th>
                        <th scope="col" class="px-4 py-3" style="min-width: 100px;">Start Date</th>
                        <th scope="col" class="px-4 py-3 text-right" style="min-width: 100px;">Enrollment</th>
                    </tr>
                </thead>
                <tbody id="trialsTableBody">
                    <!-- JS will populate this -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let dataWorker; // The single web worker instance
        let phaseChart, statusChart, sponsorChart, timeChart, conditionsChart;
        
        const newPalette = {
            dodgerBlue: '#00ACFF',
            robinsEggBlue: '#00DAC8',
            deepSapphire: '#001E63',
            sulu: '#CAFF5E',
            malibu: '#6EC3FA'
        };

        // --- UTILITY FUNCTIONS ---
        /**
         * Debounce function to limit the rate at which a function gets called.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        /**
         * Manages the loading state of the UI.
         */
        function setLoadingState(isLoading, message = '') {
            const tableBody = document.getElementById('trialsTableBody');
            const filters = document.getElementById('filters');
            
            filters.disabled = isLoading;

            if (isLoading) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-16"><div class="flex flex-col items-center justify-center"><div class="loader"></div><p class="mt-4 text-lg">${message}</p></div></td></tr>`;
            } else if (tableBody.innerHTML.includes('loader')) {
                tableBody.innerHTML = ''; 
            }
        }
        
        // --- WEB WORKER SCRIPT ---
        // This script runs in a separate thread. It fetches ALL data initially, then holds it in memory.
        // It listens for messages from the main thread containing filter values, performs all calculations,
        // and sends back a payload of ready-to-render data. This is the core performance optimization.
        const dataWorkerScript = `
            let allTrials = []; // Keep all trial data in the worker's memory

            // --- Main calculation function: runs all filtering and aggregation ---
            function processDataForDashboard(filters) {
                const { keyword, status, phase, startDateString, sponsorQuery } = filters;

                // 1. Filter the main dataset based on active filters
                const filteredTrials = allTrials.filter(trial => {
                    const keywordMatch = keyword === '' || 
                        (trial.nct && trial.nct.toLowerCase().includes(keyword)) || 
                        (trial.title && trial.title.toLowerCase().includes(keyword)) ||
                        (trial.sponsor && trial.sponsor.toLowerCase().includes(keyword)) ||
                        (trial.conditions && trial.conditions.some(c => c.toLowerCase().includes(keyword)));
                    
                    const statusMatch = status === '' || trial.status === status;
                    const phaseMatch = phase === '' || trial.phase === phase;
                    const startDateMatch = startDateString === '' || (trial.startDate && trial.startDate !== 'N/A' && trial.startDate >= startDateString);
                    const sponsorMatch = sponsorQuery === '' || (trial.sponsor && trial.sponsor.toLowerCase().includes(sponsorQuery));

                    return keywordMatch && statusMatch && phaseMatch && startDateMatch && sponsorMatch;
                });
                
                // 2. Sort the filtered results
                filteredTrials.sort((a, b) => {
                    if (a.startDate === 'N/A' || !a.startDate) return 1;
                    if (b.startDate === 'N/A' || !b.startDate) return -1;
                    return b.startDate.localeCompare(a.startDate);
                });

                // 3. Calculate KPIs from the filtered data
                const kpis = {
                    totalTrials: filteredTrials.length,
                    recruitingTrials: filteredTrials.filter(t => t.status === 'RECRUITING').length,
                    completedTrials: filteredTrials.filter(t => t.status === 'COMPLETED').length,
                    totalParticipants: filteredTrials.reduce((sum, t) => sum + (t.enrollment || 0), 0)
                };

                // 4. Aggregate data for all charts
                const phaseCounts = filteredTrials.reduce((acc, { phase }) => { acc[phase] = (acc[phase] || 0) + 1; return acc; }, {});
                const sortedPhases = Object.entries(phaseCounts).sort(([,a],[,b]) => b-a);
                
                const statusCounts = filteredTrials.reduce((acc, { status }) => { acc[status] = (acc[status] || 0) + 1; return acc; }, {});
                const sortedStatuses = Object.entries(statusCounts).sort(([,a],[,b]) => b-a);

                const timeCounts = filteredTrials.reduce((acc, { startDate }) => {
                    if(startDate && startDate !== 'N/A') {
                        const year = startDate.substring(0, 4);
                        acc[year] = (acc[year] || 0) + 1;
                    }
                    return acc;
                }, {});
                const sortedYears = Object.keys(timeCounts).sort((a, b) => a - b);
                
                const sponsorCounts = filteredTrials.reduce((acc, { sponsor }) => {
                    if (sponsor && sponsor !== 'N/A') acc[sponsor] = (acc[sponsor] || 0) + 1;
                    return acc;
                }, {});
                const topSponsors = Object.entries(sponsorCounts).sort(([,a],[,b]) => b-a).slice(0, 10).reverse();
                
                const conditionCounts = filteredTrials.reduce((acc, { conditions }) => {
                    if (Array.isArray(conditions)) conditions.forEach(c => { acc[c] = (acc[c] || 0) + 1; });
                    return acc;
                }, {});
                const topConditions = Object.entries(conditionCounts)
                    .filter(([condition]) => !condition.toLowerCase().includes('healthy'))
                    .sort(([,a],[,b]) => b-a)
                    .slice(0, 10).reverse();

                const charts = {
                    phase: { labels: sortedPhases.map(p => p[0]), data: sortedPhases.map(p => p[1]) },
                    status: { labels: sortedStatuses.map(s => s[0]), data: sortedStatuses.map(s => s[1]) },
                    time: { labels: sortedYears, data: sortedYears.map(year => timeCounts[year]) },
                    sponsor: { labels: topSponsors.map(s => s[0]), data: topSponsors.map(s => s[1]) },
                    conditions: { labels: topConditions.map(c => c[0]), data: topConditions.map(c => c[1]) }
                };

                // 5. Prepare the data for the details table, applying the display limit
                const DISPLAY_LIMIT = 200;
                const table = {
                    rows: filteredTrials.slice(0, DISPLAY_LIMIT),
                    totalCount: filteredTrials.length
                };

                // 6. Return a single payload object
                return { kpis, charts, table };
            }

            // --- Initial data fetch, runs only once when the worker starts ---
            async function fetchAndProcessInitialData() {
                const BASE_URL = 'https://clinicaltrials.gov/api/v2/studies';
                const QUERY_PARAMS = 'query.term=AREA[StartDate]RANGE[2020-01-01,MAX]+AND+AREA[OrgClass]INDUSTRY+AND+AREA[StudyType]INTERVENTIONAL';
                let nextPageToken = null;
                let allStudies = [];
                let page = 1;
                const maxPages = 50;

                try {
                    do {
                        let url = BASE_URL + '?pageSize=1000&' + QUERY_PARAMS + (nextPageToken ? '&pageToken=' + nextPageToken : '');
                        postMessage({ type: 'progress', page: page });
                        const response = await fetch(url);
                        if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
                        const data = await response.json();
                        if (data.studies) allStudies.push(...data.studies);
                        nextPageToken = data.nextPageToken;
                        page++;
                    } while (nextPageToken && page < maxPages);

                    allTrials = allStudies.map(study => {
                        const p = study.protocolSection;
                        return {
                            nct: p.identificationModule?.nctId || 'N/A',
                            title: p.identificationModule?.officialTitle || 'No title provided',
                            status: p.statusModule?.overallStatus || 'Unknown',
                            phase: p.designModule?.phases?.slice(-1)[0] || 'Not Applicable',
                            sponsor: p.sponsorCollaboratorsModule?.leadSponsor?.name || 'N/A',
                            startDate: p.statusModule?.startDateStruct?.date || 'N/A',
                            enrollment: p.designModule?.enrollmentInfo?.count || 0,
                            conditions: p.conditionsModule?.conditions || [],
                        };
                    });
                    
                    const initialDashboardData = processDataForDashboard({
                        keyword: '',
                        status: '',
                        phase: '',
                        startDateString: '',
                        sponsorQuery: ''
                    });
                    const filterOptions = {
                        statuses: [...new Set(allTrials.map(t => t.status))].sort(),
                        phases: [...new Set(allTrials.map(t => t.phase))].sort((a,b) => {
                            if (a.includes('Not Applicable')) return -1; if (b.includes('Not Applicable')) return 1; return a.localeCompare(b);
                        }),
                        sponsors: [...new Set(allTrials.map(t => t.sponsor).filter(Boolean).filter(s => s !== 'N/A'))].sort()
                    };

                    postMessage({ type: 'complete', payload: { initialDashboardData, filterOptions } });

                } catch (error) {
                    postMessage({ type: 'error', error: error.message });
                }
            }

            // --- Worker message handler to respond to filter changes ---
            self.onmessage = (e) => {
                if (e.data.type === 'filter') {
                    const dashboardData = processDataForDashboard(e.data.filters);
                    postMessage({ type: 'update', payload: dashboardData });
                }
            };

            fetchAndProcessInitialData();
        `;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            Chart.register(ChartDataLabels);
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            initializeCharts();
            setupEventListeners();
            
            // --- Start the Data Fetching and Processing in the Background Worker ---
            setLoadingState(true, 'Initializing data fetch...');
            try {
                const workerBlob = new Blob([dataWorkerScript], { type: 'application/javascript' });
                dataWorker = new Worker(URL.createObjectURL(workerBlob));
                
                // --- Central message handler for all worker communication ---
                dataWorker.onmessage = function(e) {
                    const { type, payload, page, error } = e.data;

                    if (type === 'progress') {
                        setLoadingState(true, `Fetching page ${page} from ClinicalTrials.gov...`);
                    } else if (type === 'complete') {
                        console.log(`Successfully fetched and processed initial data.`);
                        populateFilters(payload.filterOptions);
                        const initialData = payload.initialDashboardData;
                        updateKPIs(initialData.kpis);
                        updateCharts(initialData.charts);
                        updateTable(initialData.table);
                        setLoadingState(false);
                    } else if (type === 'update') {
                        updateKPIs(payload.kpis);
                        updateCharts(payload.charts);
                        updateTable(payload.table);
                        setLoadingState(false);
                    } else if (type === 'error') {
                        console.error("Error from data worker:", error);
                        document.getElementById('trialsTableBody').innerHTML = `<tr><td colspan="7" class="text-center py-8 text-red-400">Failed to load trial data: ${error}</td></tr>`;
                        setLoadingState(false);
                        dataWorker.terminate(); 
                    }
                };
                
                dataWorker.onerror = function(err) {
                    console.error("A critical error occurred in the data worker:", err);
                    document.getElementById('trialsTableBody').innerHTML = `<tr><td colspan="7" class="text-center py-8 text-red-400">A critical error occurred. See console for details.</td></tr>`;
                    setLoadingState(false);
                };
            } catch (e) {
                 console.error("Failed to initialize Web Worker:", e);
                 document.getElementById('trialsTableBody').innerHTML = `<tr><td colspan="7" class="text-center py-8 text-red-400">Could not initialize the data fetching process. Your browser may not support Web Workers.</td></tr>`;
                 setLoadingState(false);
            }
        });
        
        // --- FILTER POPULATION ---
        function populateFilters({ statuses, phases, sponsors }) {
            const statusFilter = document.getElementById('statusFilter');
            const phaseFilter = document.getElementById('phaseFilter');
            const sponsorList = document.getElementById('sponsorList');

            statusFilter.length = 1; phaseFilter.length = 1; sponsorList.innerHTML = '';

            statuses.forEach(s => statusFilter.add(new Option(s.replace(/_/g, ' '), s)));
            phases.forEach(p => phaseFilter.add(new Option(p, p)));
            
            const sponsorFragment = document.createDocumentFragment();
            sponsors.forEach(s => sponsorFragment.appendChild(new Option(s,s)));
            sponsorList.appendChild(sponsorFragment);
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            const debouncedHandler = debounce(updateDashboard, 300);
            const immediateHandler = updateDashboard;

            document.getElementById('keywordSearch').addEventListener('input', debouncedHandler);
            document.getElementById('sponsorFilter').addEventListener('input', debouncedHandler);
            document.getElementById('statusFilter').addEventListener('change', immediateHandler);
            document.getElementById('phaseFilter').addEventListener('change', immediateHandler);
            document.getElementById('startDateFilter').addEventListener('change', immediateHandler);

            document.getElementById('resetFilters').addEventListener('click', () => {
                document.getElementById('keywordSearch').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('phaseFilter').value = '';
                document.getElementById('startDateFilter').value = '';
                document.getElementById('sponsorFilter').value = '';
                updateDashboard();
            });
            
            document.getElementById('toggleFiltersHeader').addEventListener('click', () => {
                const filters = document.getElementById('filters');
                const icon = document.getElementById('toggleIcon');
                icon.classList.toggle('rotate-180', !filters.classList.toggle('hidden'));
            });
        }

        // --- CHART INITIALIZATION ---
        function initializeCharts() {
            const defaultOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' }}, datalabels: { display: false }, tooltip: { enabled: true }}, scales: { x: { ticks: { color: '#d1d5db' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }}, y: { ticks: { color: '#d1d5db' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }}}};
            const horizontalOptions = { ...defaultOptions, indexAxis: 'y' };
            const phasePalette = [newPalette.dodgerBlue, newPalette.robinsEggBlue, newPalette.sulu, newPalette.malibu, newPalette.deepSapphire];

            phaseChart = new Chart(document.getElementById('phaseChart'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: phasePalette, borderColor: '#1f2937', borderWidth: 3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: true, formatter: (v, ctx) => { const p = v / ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) * 100; if (p < 3) return ''; let l = ctx.chart.data.labels[ctx.dataIndex]; if (l.includes('Applicable')) l = 'N/A'; if (l.includes('Phase')) l = l.replace('Phase ', 'P'); return `${l}\n${p.toFixed(0)}%`; }, color: (ctx) => { const c = ctx.dataset.backgroundColor[ctx.dataIndex] || '#FFFFFF'; const r = parseInt(c.slice(1,3),16), g = parseInt(c.slice(3,5),16), b = parseInt(c.slice(5,7),16); return (r*299+g*587+b*114)/1000 > 155 ? newPalette.deepSapphire : '#FFFFFF'; }, textAlign: 'center', font: { weight: 'bold', size: 12, family: 'Inter' }}}}});
            statusChart = new Chart(document.getElementById('statusChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Number of Trials', data: [], backgroundColor: newPalette.dodgerBlue }] }, options: defaultOptions });
            sponsorChart = new Chart(document.getElementById('sponsorChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Number of Trials', data: [], backgroundColor: newPalette.malibu }] }, options: { ...horizontalOptions, plugins: { legend: { display: false }, datalabels: { display: true, color: '#FFFFFF', anchor: 'end', align: 'end', font: { weight: 'bold' } }}}});
            timeChart = new Chart(document.getElementById('timeChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'Trials Started', data: [], borderColor: newPalette.robinsEggBlue, backgroundColor: 'rgba(0, 218, 200, 0.5)', tension: 0.1, fill: false }] }, options: { ...defaultOptions, plugins: { ...defaultOptions.plugins, legend: { display: false } } } });
            conditionsChart = new Chart(document.getElementById('conditionsChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Number of Trials', data: [], backgroundColor: newPalette.sulu }] }, options: { ...horizontalOptions, plugins: { legend: { display: false }, datalabels: { display: true, color: '#FFFFFF', anchor: 'end', align: 'end', font: { weight: 'bold' } }}}});
        }
        
        // --- CORE LOGIC: Gathers filters and tells the worker to update ---
        function updateDashboard() {
            if (!dataWorker) return;
            setLoadingState(true, 'Filtering data...');
            const filters = {
                keyword: document.getElementById('keywordSearch').value.toLowerCase(),
                status: document.getElementById('statusFilter').value,
                phase: document.getElementById('phaseFilter').value,
                startDateString: document.getElementById('startDateFilter').value,
                sponsorQuery: document.getElementById('sponsorFilter').value.toLowerCase()
            };
            dataWorker.postMessage({ type: 'filter', filters: filters });
        }

        // --- "Dumb" Renderer Functions: They just update the UI with data from the worker ---
        function updateKPIs({ totalTrials, recruitingTrials, completedTrials, totalParticipants }) {
            document.getElementById('totalTrials').textContent = totalTrials.toLocaleString();
            document.getElementById('recruitingTrials').textContent = recruitingTrials.toLocaleString();
            document.getElementById('completedTrials').textContent = completedTrials.toLocaleString();
            document.getElementById('totalParticipants').textContent = totalParticipants.toLocaleString();
        }
        
        function updateCharts(charts) {
            phaseChart.data.labels = charts.phase.labels;
            phaseChart.data.datasets[0].data = charts.phase.data;
            phaseChart.update();
            
            statusChart.data.labels = charts.status.labels.map(s => s.replace(/_/g, ' '));
            statusChart.data.datasets[0].data = charts.status.data;
            statusChart.update();
            
            timeChart.data.labels = charts.time.labels;
            timeChart.data.datasets[0].data = charts.time.data;
            timeChart.update();

            sponsorChart.data.labels = charts.sponsor.labels;
            sponsorChart.data.datasets[0].data = charts.sponsor.data;
            sponsorChart.update();

            conditionsChart.data.labels = charts.conditions.labels;
            conditionsChart.data.datasets[0].data = charts.conditions.data;
            conditionsChart.update();
        }

        function updateTable({ rows, totalCount }) {
            const tableBody = document.getElementById('trialsTableBody');
            const recordCountEl = document.getElementById('tableRecordCount');
            
            if (rows.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-400">No trials match the current filters.</td></tr>`;
                recordCountEl.textContent = 'Showing 0 records';
                return;
            }

            let tableHTML = '';
            rows.forEach(trial => {
                const statusCellStyle = getStatusColor(trial.status);
                tableHTML += `<tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="px-4 py-3 font-medium text-blue-400 whitespace-nowrap"><a href="https://clinicaltrials.gov/study/${trial.nct}" target="_blank" class="hover:underline">${trial.nct}</a></td>
                        <td class="px-4 py-3 whitespace-normal break-words">${trial.title}</td>
                        <td class="px-4 py-3 text-center whitespace-nowrap"><span class="px-2 py-1 rounded-full text-xs font-semibold" style="${statusCellStyle}">${trial.status.replace(/_/g, ' ')}</span></td>
                        <td class="px-4 py-3">${trial.phase}</td>
                        <td class="px-4 py-3 whitespace-normal break-words">${trial.sponsor}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${trial.startDate}</td>
                        <td class="px-4 py-3 text-right">${(trial.enrollment || 0).toLocaleString()}</td>
                    </tr>`;
            });
            
            tableBody.innerHTML = tableHTML;
            recordCountEl.textContent = `Showing ${rows.length} of ${totalCount.toLocaleString()} records`;
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'RECRUITING': return `background-color:${newPalette.sulu}; color:${newPalette.deepSapphire};`;
                case 'COMPLETED': return `background-color:${newPalette.malibu}; color:${newPalette.deepSapphire};`;
                case 'TERMINATED': return `background-color:#F87171; color:#7f1d1d;`;
                case 'NOT_YET_RECRUITING': return `background-color:#FBBF24; color:#78350f;`;
                default: return `background-color:#4B5563; color:#F9FAFB;`;
            }
        }
    </script>
</body>
</html>



